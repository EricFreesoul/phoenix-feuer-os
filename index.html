<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8">
  <title>ü¶Ö PHOENIX v12 ‚Äî DISZIPLIN IST FREIHEIT üóΩ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#020817">
  <style>
    :root{
      --bg:#020817;
      --bg-elev:#050816;
      --card:#0b1020;
      --ink:#e5e7ff;
      --ink-dim:#9ca3c9;
      --brand:#60a5fa;
      --ok:#22c55e;
      --warn:#facc15;
      --danger:#fb7185;
      --muted:#111827;
      --ring:#3b82f6;
      --shadow:0 10px 30px rgba(0,0,0,.46);
      --radius:18px;
      --radius-sm:12px;
      --space:14px;
      --space-lg:20px;
      --tap:46px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, -system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    }
    [data-theme="light"]{
      --bg:#eef2ff;
      --bg-elev:#ffffff;
      --card:#ffffff;
      --ink:#020817;
      --ink-dim:#4b5563;
      --muted:#e5e7eb;
      --shadow:0 10px 24px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:radial-gradient(circle at top, #111827 0, #020817 55%, #000 100%);
      color:var(--ink);
      line-height:1.55;
      letter-spacing:.15px;
    }
    .wrap{
      max-width:540px;
      margin:0 auto;
      padding:env(safe-area-inset-top) var(--space) calc(94px + env(safe-area-inset-bottom));
    }
    header.top{
      position:sticky;top:0;z-index:40;
      backdrop-filter:saturate(160%) blur(10px);
      background:color-mix(in oklab,var(--bg) 92%,transparent);
      border-bottom:1px solid color-mix(in oklab,var(--ink) 10%,transparent);
      padding:10px var(--space);
    }
    .brandline{display:flex;align-items:center;gap:10px;}
    .logo{
      width:32px;height:32px;border-radius:10px;
      background:radial-gradient(120% 120% at 20% 20%, #38bdf8 0%, #6366f1 45%, #a855f7 100%);
      box-shadow:var(--shadow);
    }
    h1{
      font-size:clamp(18px,4.6vw,22px);
      margin:0;
      letter-spacing:.35px;
      font-weight:650;
    }
    .sub{
      font-size:11px;
      color:var(--ink-dim);
      margin-top:2px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .sub span{display:inline-flex;align-items:center;gap:4px}
    .grid{display:grid;gap:var(--space);margin-top:var(--space-lg)}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:var(--space);
      border:1px solid rgba(148,163,253,.12);
      box-shadow:var(--shadow);
    }
    .card h2{
      font-size:15px;
      margin:0 0 6px 0;
      letter-spacing:.25px;
      font-weight:640;
    }
    .row{display:flex;align-items:center;gap:8px}
    .row.wrap{flex-wrap:wrap}
    .muted{color:var(--ink-dim);font-size:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      min-height:var(--tap);
      padding:8px 12px;
      border-radius:14px;
      border:1px solid color-mix(in oklab,var(--ink) 12%,transparent);
      background:linear-gradient(180deg,color-mix(in oklab,var(--bg-elev) 84%,#1d2438) 0%,var(--bg-elev) 100%);
      color:var(--ink);
      font-weight:600;
      font-size:11px;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1e40af;color:#eff6ff}
    .btn.ok{background:linear-gradient(180deg,#059669,#047857);border-color:#065f46;color:#ecfdf5}
    .btn.warn{background:linear-gradient(180deg,#f97316,#ea580c);border-color:#c2410c;color:#fff7ed}
    .btn.danger{background:linear-gradient(180deg,#fb7185,#e11d48);border-color:#be123c;color:#fef2f2}
    .btn.ghost{background:transparent;box-shadow:none}
    .btn.block{width:100%}
    .btn.switch{min-width:var(--tap);font-size:13px}
    .ctl{display:flex;flex-direction:column;gap:4px}
    label{font-size:10.5px;color:var(--ink-dim)}
    input[type="text"],input[type="url"],input[type="number"],input[type="date"],textarea,select{
      width:100%;
      min-height:var(--tap);
      padding:9px 10px;
      border-radius:12px;
      border:1px solid color-mix(in oklab,var(--ink) 14%,transparent);
      background:var(--bg-elev);
      color:var(--ink);
      font-size:12.5px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    input[type="checkbox"]{width:17px;height:17px;accent-color:#22c55e;cursor:pointer}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 9px;
      border-radius:999px;
      background:color-mix(in oklab,var(--muted) 70%,transparent);
      border:1px solid rgba(148,163,253,.16);
      font-size:10px;
      color:var(--ink-dim);
    }
    .kpi{font:700 17px var(--mono);letter-spacing:.25px}
    .list{display:flex;flex-direction:column;gap:9px}
    .item{
      display:flex;align-items:flex-start;gap:10px;
      padding:9px;
      border-radius:12px;
      background:color-mix(in oklab,var(--muted) 40%,transparent);
      border:1px solid rgba(75,85,99,.55);
    }
    .item strong{font-size:13px}
    .check{
      width:21px;height:21px;border-radius:8px;
      display:grid;place-items:center;
      background:#020817;
      border:1px solid rgba(148,163,253,.26);
      cursor:pointer;flex-shrink:0;font-size:12px;
    }
    .check.done{background:#22c55e;border-color:#16a34a;color:#020817}
    .check.danger{background:color-mix(in oklab,var(--danger) 30%,transparent);border-color:var(--danger);color:#111827}
    .tag{
      font:600 9.5px var(--mono);
      padding:2px 6px;border-radius:999px;
      background:#020817;
      border:1px solid #1d2a4d;
      color:#9ca3c9;
    }
    .badge{
      font:700 17px var(--mono);
      padding:6px 10px;
      border-radius:10px;
      background:#020817;
      border:1px solid #1f2937;
      display:inline-block;
    }
    nav.tabs{
      position:fixed;bottom:0;left:0;right:0;z-index:50;
      background:color-mix(in oklab,var(--bg) 94%,#020817);
      border-top:1px solid color-mix(in oklab,var(--ink) 12%,transparent);
      padding:8px calc((100vw - 540px)/2 + var(--space)) calc(8px + env(safe-area-inset-bottom));
    }
    .tabbar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .tab{
      min-height:50px;
      border-radius:13px;
      border:1px solid rgba(75,85,99,.85);
      background:linear-gradient(180deg,var(--bg-elev),color-mix(in oklab,var(--bg-elev) 90%,#000));
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
      font-size:9.5px;
      color:var(--ink-dim);
      cursor:pointer;
    }
    .tab.active{outline:2px solid var(--ring);color:var(--ink);border-color:var(--ring)}
    .ic{font:700 12px var(--mono)}
    .template-box{
      margin-top:var(--space);
      padding:var(--space);
      border-radius:var(--radius-sm);
      background:color-mix(in oklab,var(--bg-elev) 70%,transparent);
      border:1px solid rgba(75,85,99,.7);
      font-size:11px;
    }
    .template-box pre{
      margin-top:6px;
      padding:7px;
      border-radius:8px;
      background:#020817;
      border:1px solid #111827;
      font-family:var(--mono);
      font-size:10.5px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .roadmap-content h3{
      font-size:12.5px;
      color:var(--brand);
      margin:14px 0 4px 0;
      padding-bottom:4px;
      border-bottom:1px solid rgba(75,85,99,.9);
    }
    .roadmap-content p{font-size:11.5px}
    .roadmap-content ul{padding-left:16px;font-size:11px}
    .roadmap-content li{margin-bottom:3px}
    @media (max-width:420px){
      .wrap{max-width:100%}
      .tabbar{gap:4px}
      .btn{padding:7px 9px}
    }
  </style>
</head>
<body>
<header class="top">
  <div class="brandline">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>ü¶Ö PHOENIX v12 ‚Äî DISZIPLIN IST FREIHEIT üóΩ</h1>
      <div class="sub">
        <span><span>Tag</span><span id="phoenixRange"></span></span>
        <span>¬∑</span>
        <span id="datestamp"></span>
        <span>¬∑</span>
        <span id="status">bereit</span>
      </div>
    </div>
    <div style="margin-left:auto" class="row">
      <button id="themeBtn" class="btn switch" title="Hell/Dunkel">‚òÄÔ∏è/üåô</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="view" class="grid" aria-live="polite"></section>
</main>

<nav class="tabs" role="navigation" aria-label="Prim√§re Navigation">
  <div class="tabbar">
    <button class="tab" data-tab="home"><div class="ic">üè†</div><div>Home</div></button>
    <button class="tab" data-tab="fokus"><div class="ic">‚è±Ô∏è</div><div>Fokus</div></button>
    <button class="tab" data-tab="prototypen"><div class="ic">üß≠</div><div>Prototypen</div></button>
    <button class="tab" data-tab="evidence"><div class="ic">üìé</div><div>Evidence</div></button>
    <button class="tab" data-tab="outreach"><div class="ic">üì¨</div><div>Explor.</div></button>
    <button class="tab" data-tab="manifest"><div class="ic">ü¶Ö</div><div>Manifest</div></button>
    <button class="tab active" data-tab="generator"><div class="ic">‚ö°</div><div>Generator</div></button>
  </div>
</nav>

<input id="importFile" type="file" accept="application/json" class="hide">

<script>
(() => {
  "use strict";

  const VERSION      = "12.2-omega-final";
  const STORAGE_KEY  = "PHOENIX_V12_STATE_OMEGA";
  const STORAGE_WARN_THRESHOLD = 4 * 1024 * 1024; // 4 MB
  const LEGACY_STORAGE_KEYS = [
    "PHOENIX_V12_STATE",
    "PHOENIX_STATE_V11",
    "PHOENIX_STATE"
  ];
  const EXEC_SAFE_RE = /(intern|prototype|prototyp|vorbereitung|ohne einnahmen|minibetrieb|mini-betrieb|keine rechnung)/;
  const KNOWN_TABS = new Set(["home","fokus","prototypen","evidence","outreach","manifest","generator"]);
  const PHOENIX_START = "2025-11-07";
  const PHOENIX_END   = "2026-01-31";

  const el  = (sel, root=document) => root.querySelector(sel);
  const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const view      = el("#view");
  const tabs      = els(".tab");
  const importEl  = el("#importFile");
  const themeBtn  = el("#themeBtn");

  let sprintTimer = null;
  let state = loadState() || seedState();
  state.meta = normalizeMeta(state.meta, false);
  state.guardFlags = normalizeGuardFlags(state.guardFlags, false);
  applyGuards(state.daily);

  initTheme();
  bindNav();
  bindImport();
  bindGlobal();
  render();

  // ---------- STATE ----------

  function seedState(){
    return {
      version: VERSION,
      theme: "dark",
      activeTab: "generator",
      lastSaved: Date.now(),
      phoenix: {
        start: PHOENIX_START,
        end: PHOENIX_END,
        targetRoute: "A", // A=Verbraucherinsolvenz nach bewusstem Cut; B=Regelinsolvenz + ¬ß35 II
        pKonto: false,
        businessAccountCold: false,
        piPrepared: false,
        drvNoticeSent: false,
        ltaPrepared: false,
        zeitjournalStable: false,
        tagXPackageDraft: false,
        routeDecisionNote: ""
      },
      daily: defaultDaily(),
      logbook: [],
      finances: {
        entries: [] // {id,date,type:"EIN"|"AUS",cat,amount,note,year}
      },
      home: {
        mit: [
          {id:id(),text:"Heute Mini-Betrieb transparent halten (keine Expansion, keine Grauzone).",done:false},
          {id:id(),text:"Zeitjournal & Logs sauber pflegen.",done:false},
          {id:id(),text:"80-Tage-Route kurz spiegeln.",done:false}
        ],
        kpis:{sprints:0}
      },
      sprint: {
        running:false,
        startedAt:null,
        durationMin:90,
        remainingSec:90*60,
        note:"",
        buddhaPauseBefore:false
      },
      audits: [],   // Prototypen / √úbungs-Audits
      evidence: [], // interne Evidence
      outreach: [], // Explorationskontakte mit Startklausel
      guardFlags: defaultGuardState(),
      meta: defaultMeta()
    };
  }

  function defaultDaily(date = todayISO()){
    return {
      date,
      mode:"A",                // A=Lernen/Struktur, B=Audits/Templates
      activeMinutes:0,         // arbeits√§hnliche Zeit (inkl. Mini-Betrieb + kalte Arbeit)
      healthLog:"",            // DRV-f√§higes Leistungs-/Belastungsprotokoll
      execLog:"",              // IV/InsO-Perspektive (keine verdeckte Vollselbst.)
      factsLog:"",             // neutrale T√§tigkeitsliste
      buddhaNote:"",           // nur privat, kein Extern-Export
      outreachToday:0,
      flags: defaultDailyFlags()
    };
  }

  function defaultDailyFlags(){
    return {
      longShiftNoExhaustion:false,
      execLogRisk:false
    };
  }

  function defaultGuardState(){
    return {
      daily: defaultDailyFlags(),
      messages: [],
      lastChecked: null
    };
  }

  function defaultMeta(){
    return {
      storage: {
        sizeBytes: 0,
        nearLimit: false,
        lastWarningAt: null
      }
    };
  }

  function loadState(){
    const stored = readStoredState();
    if(!stored.raw) return null;
    try{
      const parsed = JSON.parse(stored.raw);
      const migrated = migrateState(parsed);
      const normalized = normalizeState(migrated, {strict:false});

      normalized.guardFlags.daily = computeDailyFlags(normalized.daily);
      normalized.guardFlags.messages = guardMessagesFromFlags(normalized.guardFlags.daily);
      normalized.guardFlags.lastChecked = Date.now();

      normalized.version = VERSION;

      // Update storage metadata based on persisted payload size
      let payload = JSON.stringify(normalized);
      let sizeBytes = new Blob([payload]).size;
      normalized.meta.storage.sizeBytes = sizeBytes;
      normalized.meta.storage.nearLimit = sizeBytes >= STORAGE_WARN_THRESHOLD;
      if(normalized.meta.storage.nearLimit && !normalized.meta.storage.lastWarningAt){
        normalized.meta.storage.lastWarningAt = Date.now();
      }else if(!normalized.meta.storage.nearLimit){
        normalized.meta.storage.lastWarningAt = null;
      }

      // persist migrated data under current key if necessary
      if(stored.key && stored.key !== STORAGE_KEY){
        try{
          // refresh size metadata after potential timestamp updates
          payload = JSON.stringify(normalized);
          sizeBytes = new Blob([payload]).size;
          normalized.meta.storage.sizeBytes = sizeBytes;
          localStorage.setItem(STORAGE_KEY, payload);
        }catch(writeErr){
          console.warn("Migration write failed", writeErr);
        }
      }

      return normalized;
    }catch(e){
      console.warn("Load failed", e);
      return null;
    }
  }

  function readStoredState(){
    const keys = [STORAGE_KEY, ...LEGACY_STORAGE_KEYS];
    for(const key of keys){
      try{
        const raw = localStorage.getItem(key);
        if(raw){
          return {raw, key};
        }
      }catch(err){
        console.warn("Storage read failed", err);
      }
    }
    return {raw:null, key:null};
  }

  function migrateState(candidate){
    if(!isPlainObject(candidate)) return candidate;
    const clone = Object.assign({}, candidate);

    if(isPlainObject(clone.logbook) && !Array.isArray(clone.logbook)){
      clone.logbook = Object.values(clone.logbook);
    }
    if(clone.finances && isPlainObject(clone.finances) && isPlainObject(clone.finances.entries) && !Array.isArray(clone.finances.entries)){
      clone.finances.entries = Object.values(clone.finances.entries);
    }
    if(clone.daily && typeof clone.daily === "string"){
      try{
        clone.daily = JSON.parse(clone.daily);
      }catch(_){
        // ignore malformed legacy daily blobs
      }
    }
    if(Array.isArray(clone.logbook)){
      clone.logbook = clone.logbook.map(entry=>{
        if(isPlainObject(entry) && typeof entry.flags === "undefined"){
          return Object.assign({}, entry, {flags: defaultDailyFlags()});
        }
        return entry;
      });
    }
    if(isPlainObject(clone.daily) && typeof clone.daily.flags === "undefined"){
      clone.daily = Object.assign({}, clone.daily, {flags: defaultDailyFlags()});
    }
    return clone;
  }

  function normalizeState(candidate, opts={}){
    const strict = !!opts.strict;
    if(!isPlainObject(candidate)){
      if(strict) throw new Error("State muss ein Objekt sein.");
      return seedState();
    }

    const base = seedState();
    if(strict && typeof candidate.theme !== "undefined" && candidate.theme !== "dark" && candidate.theme !== "light"){
      throw new Error("theme muss 'dark' oder 'light' sein.");
    }
    const theme = candidate.theme === "light" ? "light" : base.theme;
    const tabCandidate = typeof candidate.activeTab === "string" ? candidate.activeTab : base.activeTab;
    if(strict && typeof candidate.activeTab !== "undefined" && !KNOWN_TABS.has(tabCandidate)){
      throw new Error("activeTab unbekannt.");
    }
    const out = {
      version: VERSION,
      theme,
      activeTab: KNOWN_TABS.has(tabCandidate) ? tabCandidate : base.activeTab,
      lastSaved: asNumber(candidate.lastSaved, base.lastSaved, strict, "lastSaved"),
      phoenix: normalizePhoenix(candidate.phoenix, strict),
      daily: normalizeDaily(candidate.daily, strict),
      logbook: normalizeLogbook(candidate.logbook, strict),
      finances: normalizeFinances(candidate.finances, strict),
      home: normalizeHome(candidate.home, strict),
      sprint: normalizeSprint(candidate.sprint, strict),
      audits: normalizeAudits(candidate.audits, strict),
      evidence: normalizeEvidence(candidate.evidence, strict),
      outreach: normalizeOutreach(candidate.outreach, strict),
      guardFlags: normalizeGuardFlags(candidate.guardFlags, strict),
      meta: normalizeMeta(candidate.meta, strict)
    };

    // ensure derived fields
    out.guardFlags.daily = computeDailyFlags(out.daily);
    out.guardFlags.messages = guardMessagesFromFlags(out.guardFlags.daily);
    out.guardFlags.lastChecked = Date.now();

    return out;
  }

  function normalizePhoenix(value, strict){
    const base = seedState().phoenix;
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("phoenix muss ein Objekt sein.");
      return Object.assign({}, base);
    }
    const routeCandidate = typeof value.targetRoute === "string" ? value.targetRoute : base.targetRoute;
    if(strict && routeCandidate !== "A" && routeCandidate !== "B"){
      throw new Error("phoenix.targetRoute muss 'A' oder 'B' sein.");
    }
    return {
      start: asString(value.start, base.start, strict, "phoenix.start"),
      end: asString(value.end, base.end, strict, "phoenix.end"),
      targetRoute: routeCandidate === "B" ? "B" : "A",
      pKonto: asBoolean(value.pKonto, base.pKonto, strict, "phoenix.pKonto"),
      businessAccountCold: asBoolean(value.businessAccountCold, base.businessAccountCold, strict, "phoenix.businessAccountCold"),
      piPrepared: asBoolean(value.piPrepared, base.piPrepared, strict, "phoenix.piPrepared"),
      drvNoticeSent: asBoolean(value.drvNoticeSent, base.drvNoticeSent, strict, "phoenix.drvNoticeSent"),
      ltaPrepared: asBoolean(value.ltaPrepared, base.ltaPrepared, strict, "phoenix.ltaPrepared"),
      zeitjournalStable: asBoolean(value.zeitjournalStable, base.zeitjournalStable, strict, "phoenix.zeitjournalStable"),
      tagXPackageDraft: asBoolean(value.tagXPackageDraft, base.tagXPackageDraft, strict, "phoenix.tagXPackageDraft"),
      routeDecisionNote: asString(value.routeDecisionNote, base.routeDecisionNote, strict, "phoenix.routeDecisionNote")
    };
  }

  function normalizeDaily(value, strict){
    const base = defaultDaily((isPlainObject(value) && typeof value.date === "string") ? value.date : undefined);
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("daily muss ein Objekt sein.");
      base.flags = computeDailyFlags(base);
      return base;
    }
    const out = Object.assign({}, base);
    out.date = asString(value.date, base.date, strict, "daily.date");
    const modeCandidate = typeof value.mode === "string" ? value.mode : base.mode;
    if(strict && modeCandidate !== "A" && modeCandidate !== "B"){
      throw new Error("daily.mode muss 'A' oder 'B' sein.");
    }
    out.mode = modeCandidate === "B" ? "B" : "A";
    out.activeMinutes = clamp(asNumber(value.activeMinutes, base.activeMinutes, strict, "daily.activeMinutes"), 0, 600);
    out.healthLog = asString(value.healthLog, base.healthLog, strict, "daily.healthLog");
    out.execLog = asString(value.execLog, base.execLog, strict, "daily.execLog");
    out.factsLog = asString(value.factsLog, base.factsLog, strict, "daily.factsLog");
    out.buddhaNote = asString(value.buddhaNote, base.buddhaNote, strict, "daily.buddhaNote");
    out.outreachToday = clamp(asNumber(value.outreachToday, base.outreachToday, strict, "daily.outreachToday"), 0, 9999);
    out.flags = normalizeDailyFlags(value.flags, strict);
    const computed = computeDailyFlags(out);
    out.flags = Object.assign({}, out.flags, computed);
    return out;
  }

  function normalizeDailyFlags(value, strict){
    const base = defaultDailyFlags();
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("daily.flags muss ein Objekt sein.");
      return base;
    }
    return {
      longShiftNoExhaustion: !!value.longShiftNoExhaustion,
      execLogRisk: !!value.execLogRisk
    };
  }

  function normalizeLogbook(value, strict){
    const out = [];
    if(Array.isArray(value)){
      value.forEach((entry, idx)=>{
        if(!isPlainObject(entry)){
          if(strict) throw new Error(`logbook[${idx}] muss ein Objekt sein.`);
          return;
        }
        out.push(normalizeDaily(entry, strict));
      });
      return out;
    }
    if(isPlainObject(value)){
      Object.values(value).forEach(entry=>{
        if(isPlainObject(entry)) out.push(normalizeDaily(entry, strict));
        else if(strict) throw new Error("logbook Eintr√§ge m√ºssen Objekte sein.");
      });
      return out;
    }
    if(strict && typeof value !== "undefined") throw new Error("logbook muss ein Array sein.");
    return out;
  }

  function normalizeFinances(value, strict){
    const base = {entries: []};
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("finances muss ein Objekt sein.");
      return base;
    }
    const entriesSource = Array.isArray(value.entries)
      ? value.entries
      : (isPlainObject(value.entries) ? Object.values(value.entries) : []);
    const entries = [];
    entriesSource.forEach((entry, idx)=>{
      if(!isPlainObject(entry)){
        if(strict) throw new Error(`finances.entries[${idx}] muss ein Objekt sein.`);
        return;
      }
      const date = asString(entry.date, todayISO(), strict, `finances.entries[${idx}].date`);
      const yearFallback = date ? date.slice(0,4) : todayISO().slice(0,4);
      const typeCandidate = typeof entry.type === "string" ? entry.type : undefined;
      if(strict && typeCandidate && typeCandidate !== "EIN" && typeCandidate !== "AUS"){
        throw new Error(`finances.entries[${idx}].type muss 'EIN' oder 'AUS' sein.`);
      }
      const normalized = {
        id: asString(entry.id, id(), strict, `finances.entries[${idx}].id`),
        date,
        year: asString(entry.year, yearFallback, strict, `finances.entries[${idx}].year`),
        type: typeCandidate === "AUS" ? "AUS" : "EIN",
        amount: Number.isFinite(Number(entry.amount)) ? Number(entry.amount) : asNumber(entry.amount, 0, strict, `finances.entries[${idx}].amount`),
        note: asString(entry.note, "", strict, `finances.entries[${idx}].note`),
        cat: asString(entry.cat, "", strict, `finances.entries[${idx}].cat`)
      };
      entries.push(normalized);
    });
    return {entries};
  }

  function normalizeHome(value, strict){
    const base = seedState().home;
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("home muss ein Objekt sein.");
      return {
        mit: base.mit.map((item, idx)=>normalizeMitItem(item, idx, strict)),
        kpis: {sprints: base.kpis.sprints}
      };
    }
    const mitSource = Array.isArray(value.mit)
      ? value.mit
      : (isPlainObject(value.mit) ? Object.values(value.mit) : base.mit);
    const mit = mitSource.map((item, idx)=>normalizeMitItem(item, idx, strict));
    const kpisSource = isPlainObject(value.kpis) ? value.kpis : {};
    const kpis = {
      sprints: clamp(asNumber(kpisSource.sprints, base.kpis.sprints, strict, "home.kpis.sprints"), 0, 9999)
    };
    return {mit, kpis};
  }

  function normalizeMitItem(value, idx, strict){
    if(!isPlainObject(value)){
      if(strict) throw new Error(`home.mit[${idx}] muss ein Objekt sein.`);
      return {
        id: id(),
        text: "",
        done: false
      };
    }
    return {
      id: asString(value.id, id(), strict, `home.mit[${idx}].id`),
      text: asString(value.text, "", strict, `home.mit[${idx}].text`),
      done: !!value.done
    };
  }

  function normalizeSprint(value, strict){
    const base = seedState().sprint;
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("sprint muss ein Objekt sein.");
      return Object.assign({}, base);
    }
    return {
      running: !!value.running,
      startedAt: typeof value.startedAt === "string" ? value.startedAt : null,
      durationMin: clamp(asNumber(value.durationMin, base.durationMin, strict, "sprint.durationMin"), 1, 600),
      remainingSec: clamp(asNumber(value.remainingSec, base.remainingSec, strict, "sprint.remainingSec"), 0, 600*60),
      note: asString(value.note, base.note, strict, "sprint.note"),
      buddhaPauseBefore: !!value.buddhaPauseBefore
    };
  }

  function normalizeAudits(value, strict){
    const out = [];
    const stages = ["NEU","IN_ARBEIT","ENTWURF","FERTIG_INTERNAL"];
    if(Array.isArray(value)){
      value.forEach((entry, idx)=>{
        if(!isPlainObject(entry)){
          if(strict) throw new Error(`audits[${idx}] muss ein Objekt sein.`);
          return;
        }
        const gateSource = isPlainObject(entry.gate) ? entry.gate : {};
        const gate = {};
        Object.keys(gateSource).forEach(k=>{gate[k]=!!gateSource[k];});
        const stageCandidate = typeof entry.stage === "string" ? entry.stage : undefined;
        if(strict && stageCandidate && !stages.includes(stageCandidate)){
          throw new Error(`audits[${idx}].stage ung√ºltig.`);
        }
        out.push({
          id: asString(entry.id, id(), strict, `audits[${idx}].id`),
          domain: asString(entry.domain, "", strict, `audits[${idx}].domain`),
          stage: stages.includes(stageCandidate) ? stageCandidate : "NEU",
          created: asString(entry.created, todayISO(), strict, `audits[${idx}].created`),
          gate,
          gateScore: clamp(asNumber(entry.gateScore, 0, strict, `audits[${idx}].gateScore`), 0, 100)
        });
      });
      return out;
    }
    if(strict && typeof value !== "undefined") throw new Error("audits muss ein Array sein.");
    return out;
  }

  function normalizeEvidence(value, strict){
    const out = [];
    if(Array.isArray(value)){
      value.forEach((entry, idx)=>{
        if(!isPlainObject(entry)){
          if(strict) throw new Error(`evidence[${idx}] muss ein Objekt sein.`);
          return;
        }
        out.push({
          id: asString(entry.id, id(), strict, `evidence[${idx}].id`),
          title: asString(entry.title, "", strict, `evidence[${idx}].title`),
          url: asString(entry.url, "", strict, `evidence[${idx}].url`),
          type: asString(entry.type, "P0", strict, `evidence[${idx}].type`),
          auditId: entry.auditId ? asString(entry.auditId, "", strict, `evidence[${idx}].auditId`) : null,
          note: asString(entry.note, "", strict, `evidence[${idx}].note`),
          ts: asString(entry.ts, new Date().toISOString(), strict, `evidence[${idx}].ts`)
        });
      });
      return out;
    }
    if(strict && typeof value !== "undefined") throw new Error("evidence muss ein Array sein.");
    return out;
  }

  function normalizeOutreach(value, strict){
    const out = [];
    if(Array.isArray(value)){
      value.forEach((entry, idx)=>{
        if(!isPlainObject(entry)){
          if(strict) throw new Error(`outreach[${idx}] muss ein Objekt sein.`);
          return;
        }
        const contact = typeof entry.contact === "string" ? entry.contact : entry.name;
        const notes = typeof entry.notes === "string" ? entry.notes : entry.note;
        out.push({
          id: asString(entry.id, id(), strict, `outreach[${idx}].id`),
          contact: asString(contact, "", strict, `outreach[${idx}].contact`),
          channel: asString(entry.channel, "", strict, `outreach[${idx}].channel`),
          handle: asString(entry.handle, "", strict, `outreach[${idx}].handle`),
          notes: asString(notes, "", strict, `outreach[${idx}].notes`),
          created: asString(entry.created, todayISO(), strict, `outreach[${idx}].created`),
          status: asString(entry.status, "EXPLORATION", strict, `outreach[${idx}].status`)
        });
      });
      return out;
    }
    if(strict && typeof value !== "undefined") throw new Error("outreach muss ein Array sein.");
    return out;
  }

  function normalizeGuardFlags(value, strict){
    const base = defaultGuardState();
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("guardFlags muss ein Objekt sein.");
      return base;
    }
    const daily = isPlainObject(value.daily) ? {
      longShiftNoExhaustion: !!value.daily.longShiftNoExhaustion,
      execLogRisk: !!value.daily.execLogRisk
    } : defaultDailyFlags();
    const messages = Array.isArray(value.messages) ? value.messages.filter(v=>typeof v === "string") : [];
    return {
      daily,
      messages,
      lastChecked: typeof value.lastChecked === "number" ? value.lastChecked : null
    };
  }

  function normalizeMeta(value, strict){
    const base = defaultMeta();
    if(!isPlainObject(value)){
      if(strict && typeof value !== "undefined") throw new Error("meta muss ein Objekt sein.");
      return base;
    }
    const storage = isPlainObject(value.storage) ? value.storage : {};
    return {
      storage: {
        sizeBytes: clamp(asNumber(storage.sizeBytes, base.storage.sizeBytes, strict, "meta.storage.sizeBytes"), 0, Number.MAX_SAFE_INTEGER),
        nearLimit: !!storage.nearLimit,
        lastWarningAt: typeof storage.lastWarningAt === "number" ? storage.lastWarningAt : null
      }
    };
  }

  function isPlainObject(value){
    return !!value && typeof value === "object" && !Array.isArray(value);
  }

  function asString(value, fallback, strict, path){
    if(typeof value === "string") return value;
    if(strict) throw new Error(`${path} muss eine Zeichenkette sein.`);
    return fallback;
  }

  function asNumber(value, fallback, strict, path){
    if(typeof value === "number" && !Number.isNaN(value)) return value;
    if(typeof value === "string" && value.trim() !== "" && !Number.isNaN(Number(value))) return Number(value);
    if(strict) throw new Error(`${path} muss eine Zahl sein.`);
    return fallback;
  }

  function asBoolean(value, fallback, strict, path){
    if(typeof value === "boolean") return value;
    if(strict) throw new Error(`${path} muss ein Boolescher Wert sein.`);
    return fallback;
  }

  function saveState(options = {}){
    const opts = options || {};
    applyGuards(state.daily);
    state.lastSaved = Date.now();
    try{
      state.meta = normalizeMeta(state.meta, false);
      state.guardFlags = normalizeGuardFlags(state.guardFlags, false);
      state.guardFlags.daily = computeDailyFlags(state.daily);
      state.guardFlags.messages = guardMessagesFromFlags(state.guardFlags.daily);
      state.guardFlags.lastChecked = Date.now();

      let payload = JSON.stringify(state);
      let sizeBytes = new Blob([payload]).size;
      state.meta.storage.sizeBytes = sizeBytes;
      state.meta.storage.nearLimit = sizeBytes >= STORAGE_WARN_THRESHOLD;
      state.meta.storage.lastWarningAt = state.meta.storage.nearLimit ? Date.now() : null;

      payload = JSON.stringify(state);
      sizeBytes = new Blob([payload]).size;
      state.meta.storage.sizeBytes = sizeBytes;

      localStorage.setItem(STORAGE_KEY, payload);

      if(state.meta.storage.nearLimit){
        setStatus("Warnung: Speicher fast voll (~4 MB). Bitte Backup/Archiv pr√ºfen.");
      } else if(!opts.skipStatus){
        setStatus("gespeichert");
        setTimeout(()=>setStatus("bereit"),600);
      }
    }catch(e){
      console.warn("Save failed", e);
      if(!opts.skipStatus){
        setStatus("Speicherfehler");
      }
    }
  }

  // ---------- UTIL ----------

  function id(){return Math.random().toString(36).slice(2,10);}
  function todayISO(){return new Date().toISOString().slice(0,10);}
  function at00(d){return new Date(d + "T00:00:00");}
  function clamp(v,min,max){return v<min?min:(v>max?max:v);}
  function escapeHTML(s=""){
    return s.replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function setStatus(t){el("#status").textContent = t;}
  function copyToClipboard(text){
    if(!navigator.clipboard){setStatus("Clipboard nicht verf√ºgbar");return;}
    navigator.clipboard.writeText(text)
      .then(()=>{setStatus("kopiert");setTimeout(()=>setStatus("bereit"),600);})
      .catch(()=>setStatus("Kopieren fehlgeschlagen"));
  }

  function phoenixDayInfo(){
    const start = at00(PHOENIX_START);
    const end   = at00(PHOENIX_END);
    const now   = at00(todayISO());
    const total = Math.round((end - start)/(1000*60*60*24)) + 1;
    const passed = clamp(Math.round((now - start)/(1000*60*60*24)) + 1,0,total);
    const left   = clamp(total - passed,0,total);
    return {total,passed,left};
  }

  function filterLogsByRange(allLogs, range){
    const today = at00(todayISO());
    let cut = new Date(today);
    if(range === "30") cut.setDate(today.getDate() - 30);
    if(range === "60") cut.setDate(today.getDate() - 60);
    if(range === "all"){
      return allLogs.slice().sort((a,b)=>at00(a.date)-at00(b.date));
    }
    return allLogs
      .filter(l => at00(l.date) >= cut)
      .sort((a,b)=>at00(a.date)-at00(b.date));
  }

  // ---------- COMPLIANCE GUARDS ----------

  function applyGuards(d){
    if(!d || typeof d !== "object") return;
    const flags = computeDailyFlags(d);
    const mergedFlags = Object.assign({}, defaultDailyFlags(), d.flags || {}, flags);
    d.flags = mergedFlags;

    if(state){
      state.guardFlags = normalizeGuardFlags(state.guardFlags, false);
      state.guardFlags.daily = Object.assign({}, flags);
      state.guardFlags.messages = guardMessagesFromFlags(flags);
      state.guardFlags.lastChecked = Date.now();

      if(Array.isArray(state.logbook)){
        const entry = state.logbook.find(l=>l && l.date === d.date);
        if(entry){
          entry.flags = Object.assign({}, entry.flags || {}, flags);
        }
      }
    }
  }

  function computeDailyFlags(d){
    const base = defaultDailyFlags();
    if(!d || typeof d !== "object") return base;
    const health = (d.healthLog || "").toLowerCase();
    const exec   = (d.execLog || "").toLowerCase();
    const mins   = Number(d.activeMinutes) || 0;
    return {
      longShiftNoExhaustion: mins > 180 && !health.includes("ersch√∂pf"),
      execLogRisk: !!exec && !EXEC_SAFE_RE.test(exec)
    };
  }

  function guardMessagesFromFlags(flags){
    const msgs = [];
    if(flags.longShiftNoExhaustion){
      msgs.push(">3h aktiv ohne Ersch√∂pfungsprotokoll ‚Äì DRV-Risiko pr√ºfen.");
    }
    if(flags.execLogRisk){
      msgs.push("Executive-Log ohne klare Abgrenzung ‚Äì Formulierungen sch√§rfen.");
    }
    return msgs;
  }

  function evaluateGlobalWarnings(){
    const out = [];
    const guardMsgs = (state.guardFlags && Array.isArray(state.guardFlags.messages)) ? state.guardFlags.messages : [];
    guardMsgs.forEach(text=>out.push({lvl:"warn",text}));

    if(state.meta && state.meta.storage && state.meta.storage.nearLimit){
      out.push({lvl:"warn",text:"localStorage fast voll (~4 MB) ‚Äì Backup erstellen und alte Daten pr√ºfen."});
    }
    // Zeitjournal-Tage
    const daysSet = new Set(state.logbook.map(l=>l.date));
    if(daysSet.size < 30){
      out.push({lvl:"warn",text:"Zeitjournal unter 30 Tagen ‚Äì f√ºr DRV & IV noch d√ºnn. Kontinuierlich weiterf√ºhren."});
    } else if(daysSet.size < 60){
      out.push({lvl:"info",text:`Zeitjournal ${daysSet.size} Tage ‚Äì solide Basis im Aufbau.`});
    } else {
      state.phoenix.zeitjournalStable = true;
    }
    // Finanzen: Hinzuverdienst grob
    const year = new Date().getFullYear().toString();
    const sumYear = state.finances.entries
      .filter(e=>e.type==="EIN" && (e.year===year || (e.date||"").startsWith(year)))
      .reduce((n,e)=>n+(Number(e.amount)||0),0);
    if(sumYear > 0 && sumYear > 15000){
      out.push({lvl:"warn",text:`Hinzuverdienst ${sumYear.toFixed(2)} ‚Ç¨ ‚Äì aktuelle Grenzen pr√ºfen (individuelles Rentenkonto, Bescheid).`});
    }
    // Outreach ohne Startklausel
    const riskOut = state.outreach.filter(o=>o.status !== "EXPLORATION (Klausel OK)");
    if(riskOut.length){
      out.push({lvl:"warn",text:"Explorationskontakte ohne best√§tigte Startklausel vorhanden ‚Äì pr√ºfen und nachziehen."});
    }
    // Prototypen
    const fert = state.audits.filter(a=>a.stage==="FERTIG_INTERNAL").length;
    if(fert < 3){
      out.push({lvl:"info",text:`Bisher ${fert} fertige Prototypen. Ziel Tag X: mind. 3‚Äì5 belastbare √úbungs-Audits.`});
    }
    return out;
  }

  // ---------- INIT ----------

  function initTheme(){
    document.documentElement.dataset.theme = state.theme === "light" ? "light" : "dark";
    if(themeBtn){
      themeBtn.onclick = () => {
        state.theme = state.theme === "dark" ? "light" : "dark";
        document.documentElement.dataset.theme = state.theme;
        saveState();
      };
    }
  }

  function bindNav(){
    tabs.forEach(t=>{
      t.addEventListener("click",()=>{
        state.activeTab = t.dataset.tab;
        saveState();
        render();
      });
    });
  }

  function bindImport(){
    if(!importEl) return;
    importEl.addEventListener("change",e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const data = JSON.parse(ev.target.result);
          const migrated = migrateState(data);
          const normalized = normalizeState(migrated, {strict:true});
          state = normalized;
          state.meta = normalizeMeta(state.meta, false);
          state.guardFlags = normalizeGuardFlags(state.guardFlags, false);
          applyGuards(state.daily);
          saveState({skipStatus:true});
          if(state.meta && state.meta.storage && state.meta.storage.nearLimit){
            setStatus("Import ok ¬∑ Speicher fast voll (~4 MB)");
          }else{
            setStatus("Import ok");
          }
          location.reload();
        }catch(err){
          console.error(err);
          setStatus("Import ung√ºltig");
        }
      };
      reader.readAsText(file);
    });
  }

  function bindGlobal(){
    document.addEventListener("click",e=>{
      const copy = e.target.closest(".copy-btn");
      if(copy){
        const target = copy.dataset.copyTarget;
        const src = target && el("#"+target);
        if(src){
          const txt = src.textContent || src.value || "";
          copyToClipboard(txt);
        }
      }
    });
  }

  // ---------- EXPORT / ARCHIV ----------

  function archiveCurrentDaily(){
    const cur = state.daily;
    if(!cur || !cur.date) return;
    applyGuards(cur);
    const idx = state.logbook.findIndex(l=>l.date === cur.date);
    const clone = JSON.parse(JSON.stringify(cur));
    if(idx > -1) state.logbook[idx] = clone;
    else state.logbook.push(clone);
  }

  function exportJSON(){
    archiveCurrentDaily();
    saveState();
    const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${todayISO()}_PHOENIX_v12_backup.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    setStatus("Export erstellt");
  }

  // ---------- ROOT RENDER ----------

  function render(){
    const now = new Intl.DateTimeFormat("de-DE",{dateStyle:"full",timeStyle:"short"}).format(new Date());
    el("#datestamp").textContent = now;

    const info = phoenixDayInfo();
    el("#phoenixRange").textContent =
      info.passed<=0
        ? `Start ab ${PHOENIX_START}`
        : (info.left<=0
            ? `Tag ${info.total} ¬∑ Fenster abgeschlossen`
            : `Tag ${info.passed}/${info.total} ¬∑ noch ${info.left}`);

    tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab === state.activeTab));
    view.innerHTML = "";

    const map = {
      home:       renderHome,
      fokus:      renderFokus,
      prototypen: renderPrototypen,
      evidence:   renderEvidence,
      outreach:   renderOutreach,
      manifest:   renderManifest,
      generator:  renderGenerator
    };
    (map[state.activeTab] || renderHome)();
  }

  // ---------- HOME ----------

  function renderHome(){
    const c = document.createElement("div");
    c.className = "grid";

    const warns = evaluateGlobalWarnings();
    if(warns.length){
      const w = document.createElement("div");
      w.className = "card";
      w.innerHTML = `<h2>Compliance-Monitor</h2>`;
      const ul = document.createElement("div");
      ul.className = "list";
      warns.forEach(n=>{
        const it = document.createElement("div");
        it.className = "item";
        const col =
          n.lvl==="danger" ? "danger" :
          n.lvl==="warn"   ? "warn"   : "okc";
        it.innerHTML = `<div class="${col}">‚óè</div><div class="muted">${escapeHTML(n.text)}</div>`;
        ul.append(it);
      });
      w.append(ul);
      c.append(w);
    }

    c.append(
      cardPhoenixStatus(),
      cardDailyProtection(),
      cardMIT(),
      cardLogs(),
      cardBuddha(),
      cardFinanceMini(),
      cardTools(),
      cardQuickActions(),
      cardBackup()
    );
    view.append(c);
  }

  function cardPhoenixStatus(){
    const {total,passed,left} = phoenixDayInfo();
    const p = state.phoenix;
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h2>Projekt PHOENIX ¬∑ 80-Tage-Kompass</h2>
      <div class="row wrap">
        <div class="pill"><span>Fenster</span><span class="tag">${PHOENIX_START} ‚Üí ${PHOENIX_END}</span></div>
        <div class="pill"><span>Heute</span><span class="tag">${passed>0?passed:0}/${total}</span></div>
        <div class="pill"><span>Rest</span><span class="tag">${left>=0?left:0}</span></div>
        <div class="pill">
          <span>Route</span>
          <select id="routeSel" class="tag">
            <option value="A" ${p.targetRoute==="A"?"selected":""}>A: Verbr.-InsO nach Cut</option>
            <option value="B" ${p.targetRoute==="B"?"selected":""}>B: RegelinsO + ¬ß35 II</option>
          </select>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">
        Diese Oberfl√§che h√§lt Mini-Betrieb, EM-Rente und Insolvenzziel synchron:
        Keine verdeckte Expansion, klare Trennung von realer T√§tigkeit und kalter Vorbereitung,
        belastbare Unterlagen f√ºr DRV, Finanzamt und Insolvenzverwalter.
      </div>
      <div class="list" style="margin-top:8px">
        <div class="item">
          <div class="check ${p.pKonto?'done':'danger'}" data-flag="pKonto">${p.pKonto?'‚úì':'!'}</div>
          <div><strong>P-Konto gesetzt</strong><div class="muted">Basisschutz aktivieren, bevor es eng wird.</div></div>
        </div>
        <div class="item">
          <div class="check ${p.businessAccountCold?'done':'danger'}" data-flag="businessAccountCold">${p.businessAccountCold?'‚úì':'!'}</div>
          <div><strong>Gesch√§ftskonto ‚Äûkalt‚Äú vorbereitet</strong><div class="muted">Saubere Trennung, keine Altlasten, keine verdeckte Vermischung.</div></div>
        </div>
        <div class="item">
          <div class="check ${p.piPrepared?'done':'danger'}" data-flag="piPrepared">${p.piPrepared?'‚úì':'!'}</div>
          <div><strong>Insolvenzantrag (Unterlagen) vorbereitet</strong><div class="muted">Gl√§ubigerliste, Verm√∂gens√ºbersicht, Bescheinigung ‚Äì pr√ºff√§hig angelegt.</div></div>
        </div>
      </div>
    `;
    d.addEventListener("click",e=>{
      const box = e.target.closest(".check[data-flag]");
      if(box){
        const k = box.dataset.flag;
        state.phoenix[k] = !state.phoenix[k];
        saveState(); render();
      }
    });
    d.querySelector("#routeSel").onchange = e=>{
      state.phoenix.targetRoute = e.target.value;
      saveState();
    };
    return d;
  }

  function cardDailyProtection(){
    const d = document.createElement("div");
    const day = state.daily.date || todayISO();
    const mins = state.daily.activeMinutes || 0;
    const over = mins > 180;
    d.className = "card";
    d.innerHTML = `
      <h2>T√§gliches Schutz-Protokoll</h2>
      <div class="row">
        <div class="ctl">
          <label>Datum</label>
          <input id="dpDate" type="date" value="${day}">
        </div>
        <div class="ctl">
          <label>Arbeits√§hnliche Minuten (Mini-Betrieb + Aufbau)</label>
          <input id="dpMins" type="number" min="0" max="600" step="5" value="${mins}">
        </div>
      </div>
      <div class="row wrap" style="margin-top:6px">
        <div class="pill">
          <span>Limit Leitplanke</span>
          <span class="tag" style="color:${over?'#fb7185':'#22c55e'}">${mins}/180</span>
        </div>
        <label class="pill">
          <input type="radio" name="mode" value="A" ${state.daily.mode==="A"?"checked":""}>
          <span>Modus A ¬∑ Lernen/Struktur</span>
        </label>
        <label class="pill">
          <input type="radio" name="mode" value="B" ${state.daily.mode==="B"?"checked":""}>
          <span>Modus B ¬∑ √úbungs-Audits/Templates</span>
        </label>
      </div>
      <div class="muted" style="margin-top:4px">
        Trage nur T√§tigkeiten ein, die als Arbeit gelesen werden k√∂nnten.
        Regeneration, Buddha-Zeit, Spaziergang bleiben drau√üen.
      </div>
    `;
    const dateEl = d.querySelector("#dpDate");
    const minEl  = d.querySelector("#dpMins");

    dateEl.onchange = e=>{
      const newDate = e.target.value || todayISO();
      // aktuelles daily archivieren
      archiveCurrentDaily();
      // neues laden oder frisches Daily
      const exist = state.logbook.find(l=>l.date===newDate);
      state.daily = exist ? JSON.parse(JSON.stringify(exist)) : defaultDaily(newDate);
      saveState(); render();
    };
    minEl.onchange = e=>{
      const v = parseInt(e.target.value||"0",10);
      state.daily.activeMinutes = clamp(isNaN(v)?0:v,0,600);
      saveState(); render();
    };
    d.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.onchange = ev=>{
        state.daily.mode = ev.target.value;
        saveState();
      };
    });
    return d;
  }

  function cardMIT(){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<h2>Prim√§r-Direktiven f√ºr heute (max. 3)</h2>`;
    const list = document.createElement("div");
    list.className = "list";
    state.home.mit.forEach(item=>{
      const it = document.createElement("div");
      it.className = "item";
      const chk = document.createElement("div");
      chk.className = "check"+(item.done?" done":"");
      chk.textContent = item.done ? "‚úì" : "";
      chk.onclick = ()=>{
        item.done = !item.done;
        saveState(); render();
      };
      const txt = document.createElement("div");
      txt.innerHTML = `<strong>${escapeHTML(item.text)}</strong>`;
      it.append(chk,txt);
      list.append(it);
    });
    const add = document.createElement("div");
    add.className = "row";
    add.innerHTML = `
      <div class="ctl" style="flex:1">
        <label>Neue Direktive</label>
        <input id="mitNew" type="text" maxlength="90" placeholder="Kurz, klar, ohne Pathos.">
      </div>
      <button class="btn ok" id="mitAdd">+</button>
    `;
    add.querySelector("#mitAdd").onclick = ()=>{
      const v = add.querySelector("#mitNew").value.trim();
      if(!v) return;
      if(state.home.mit.length>=3) state.home.mit.shift();
      state.home.mit.push({id:id(),text:v,done:false});
      saveState(); render();
    };
    d.append(list,add);
    return d;
  }

  function cardLogs(){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h2>Logbuch ¬∑ Drei Perspektiven</h2>
      <div class="ctl">
        <label>Gesundheits-/Belastungslog (f√ºr DRV ¬∑ sachlich)</label>
        <textarea id="lgHealth" placeholder="z. B. 120 Min Belastung, danach Kopfschmerz, 30 Min Ruhe.">${escapeHTML(state.daily.healthLog||"")}</textarea>
      </div>
      <div class="ctl">
        <label>Executive Summary (f√ºr IV ¬∑ Vorbereitung, keine verdeckten Ums√§tze)</label>
        <textarea id="lgExec" placeholder="z. B. Interne Prototypenarbeit, kein Kundenkontakt, keine Rechnungen.">${escapeHTML(state.daily.execLog||"")}</textarea>
      </div>
      <div class="ctl">
        <label>Fakten-Log (Was genau erledigt? Neutral.)</label>
        <textarea id="lgFacts" placeholder="z. B. 10:00‚Äì11:30: Test-Audit Struktur √ºberarbeitet; 1 Mini-Textauftrag (15 ‚Ç¨) dokumentiert.">${escapeHTML(state.daily.factsLog||"")}</textarea>
      </div>
      <div class="muted" style="margin-top:4px">
        Diese drei Ebenen m√ºssen zusammenpassen.
        Widerspr√ºche sind Gift in jedem Verfahren.
      </div>
    `;
    d.querySelector("#lgHealth").oninput = e=>{
      state.daily.healthLog = e.target.value;
      saveState();
    };
    d.querySelector("#lgExec").oninput = e=>{
      state.daily.execLog = e.target.value;
      saveState();
    };
    d.querySelector("#lgFacts").oninput = e=>{
      state.daily.factsLog = e.target.value;
      saveState();
    };
    return d;
  }

  function cardBuddha(){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h2>Buddha-Checkpoint üêæ</h2>
      <div class="muted">
        Buddha ist dein Kater und dein Taktgeber.
        Wenn du √ºberziehst, Pause mit ihm (ca. 10 Min), dann ein klar gesetzter 90-Minuten-Fokusblock.
        Dieser Bereich ist rein privat und wird in keinem externen Report ausgegeben.
      </div>
      <div class="ctl" style="margin-top:6px">
        <label>Notiz (optional)</label>
        <textarea id="bdNote" placeholder="z. B. 2x Pause mit Buddha, Stress runter, dann fokussierter Sprint.">${escapeHTML(state.daily.buddhaNote||"")}</textarea>
      </div>
    `;
    d.querySelector("#bdNote").oninput = e=>{
      state.daily.buddhaNote = e.target.value;
      saveState();
    };
    return d;
  }

  function cardFinanceMini(){
    const d = document.createElement("div");
    d.className = "card";
    const year = new Date().getFullYear().toString();
    const ein = state.finances.entries.filter(e=>e.type==="EIN" && (e.year===year || (e.date||"").startsWith(year)))
                .reduce((n,e)=>n+(Number(e.amount)||0),0);
    const aus = state.finances.entries.filter(e=>e.type==="AUS" && (e.year===year || (e.date||"").startsWith(year)))
                .reduce((n,e)=>n+(Number(e.amount)||0),0);
    d.innerHTML = `
      <h2>Mini-Betrieb ¬∑ Finanz-Snapshot</h2>
      <div class="row wrap">
        <div class="pill"><span>Einnahmen ${year}</span><span class="tag">${ein.toFixed(2)} ‚Ç¨</span></div>
        <div class="pill"><span>Ausgaben ${year}</span><span class="tag">${aus.toFixed(2)} ‚Ç¨</span></div>
        <div class="pill"><span>Ergebnis</span><span class="tag">${(ein-aus).toFixed(2)} ‚Ç¨</span></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="ctl">
          <label>Datum</label>
          <input id="fiDate" type="date" value="${todayISO()}">
        </div>
        <div class="ctl">
          <label>Typ</label>
          <select id="fiType">
            <option value="EIN">Einnahme (Mini-Auftrag)</option>
            <option value="AUS">Ausgabe (Tool, Technik)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:4px">
        <div class="ctl">
          <label>Betrag (‚Ç¨)</label>
          <input id="fiAmount" type="number" min="0" step="0.01">
        </div>
        <div class="ctl">
          <label>Kategorie / Notiz</label>
          <input id="fiNote" type="text" placeholder="z. B. Plattform X ¬∑ Kurzauftrag">
        </div>
      </div>
      <button class="btn ok block" id="fiAdd" style="margin-top:6px">Eintrag speichern</button>
      <div class="muted" style="margin-top:4px">
        Nur echte Buchungen erfassen.
        Diese Liste bildet deine Kurz-E√úR und Hinzuverdienstbasis ab.
      </div>
    `;
    d.querySelector("#fiAdd").onclick = ()=>{
      const date = d.querySelector("#fiDate").value || todayISO();
      const type = d.querySelector("#fiType").value;
      const amount = parseFloat(d.querySelector("#fiAmount").value||"0");
      const note = d.querySelector("#fiNote").value.trim();
      if(!amount) return;
      state.finances.entries.unshift({
        id:id(),
        date,
        year: (date||todayISO()).slice(0,4),
        type,
        amount,
        note,
        cat:""
      });
      saveState(); render();
    };
    return d;
  }

  function cardTools(){
    const d = document.createElement("div");
    const dt = state.daily.date || todayISO();
    d.className = "card";
    d.innerHTML = `
      <h2>Dateistruktur-Helfer</h2>
      <div class="row">
        <div class="ctl">
          <label>Datum</label>
          <input id="tDate" type="date" value="${dt}">
        </div>
        <div class="ctl">
          <label>Test-/√úbungsdomain</label>
          <input id="tDomain" type="text" placeholder="example-immobilien.de">
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn primary" id="tPaths">Ordnerstruktur</button>
        <button class="btn" id="tNames">Dateinamen</button>
      </div>
      <div class="template-box">
        <strong>Struktur</strong>
        <pre id="pathsOut">(Ausgabe)</pre>
        <button class="btn ok block copy-btn" data-copy-target="pathsOut">Pfade kopieren</button>
      </div>
      <div class="template-box">
        <strong>Dateinamen</strong>
        <pre id="namesOut">(Ausgabe)</pre>
        <button class="btn ok block copy-btn" data-copy-target="namesOut">Namen kopieren</button>
      </div>
    `;
    d.querySelector("#tPaths").onclick = ()=>{
      const date = d.querySelector("#tDate").value || dt;
      const dom  = (d.querySelector("#tDomain").value || "domain.tld").toLowerCase();
      const root = `/PHOENIX/${date}_${dom}/`;
      el("#pathsOut").textContent = `${root}
${root}01_ZEITJOURNAL/
${root}02_TEST_AUDITS/
${root}03_SCREENSHOTS/
${root}04_CODE_SNIPS/
${root}05_SERP/
${root}06_REPORT_ENTWURF/
${root}07_TAGX_PAKET/
${root}08_RECHT_UNTERLAGEN/`;
      setStatus("Pfade generiert");
    };
    d.querySelector("#tNames").onclick = ()=>{
      const date = d.querySelector("#tDate").value || dt;
      const dom  = (d.querySelector("#tDomain").value || "domain.tld").toLowerCase();
      el("#namesOut").textContent =
`${date}_${dom}_INTERN_AUDIT_v01.docx
${date}_${dom}_EXEC_SUMMARY_INTERN_v01.docx
${date}_${dom}_P0P1_CHECKLISTE_v01.xlsx
${date}_${dom}_TAGX_PAKET_ENTWURF_v01.pdf`;
      setStatus("Dateinamen generiert");
    };
    return d;
  }

  function cardQuickActions(){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h2>Quick Actions</h2>
      <div class="row">
        <button class="btn primary block" id="qaFokus">‚è±Ô∏è 90-Min-Fokus starten</button>
        <button class="btn block" id="qaManifest">ü¶Ö Manifest √∂ffnen</button>
      </div>
      <div class="muted" style="margin-top:4px">
        Fokus-Slots sind harte Belastungszeit.
        Nutze sie gezielt: Lernen, Prototypen, Tag-X-Dokumente. Kein echter Kundenservice.
      </div>
    `;
    d.querySelector("#qaFokus").onclick = ()=>{
      state.activeTab = "fokus";
      saveState(); render();
    };
    d.querySelector("#qaManifest").onclick = ()=>{
      state.activeTab = "manifest";
      saveState(); render();
    };
    return d;
  }

  function cardBackup(){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <h2>Backup</h2>
      <div class="row">
        <button class="btn block" id="exp">‚¨áÔ∏è Export JSON</button>
        <button class="btn block" id="imp">‚¨ÜÔ∏è Import JSON</button>
      </div>
      <div class="muted" style="margin-top:4px">
        Empfehlung: regelm√§√üig sichern als <code>YYYY-MM-DD_PHOENIX_v12_backup.json</code>.
      </div>
    `;
    d.querySelector("#exp").onclick = exportJSON;
    d.querySelector("#imp").onclick = ()=>importEl.click();
    return d;
  }

  // ---------- FOKUS / SPRINT ----------

  function renderFokus(){
    const wrap = document.createElement("div");
    wrap.className = "grid";
    const s = state.sprint;
    const remaining = s.remainingSec || s.durationMin*60;
    const dailyM = state.daily.activeMinutes || 0;
    const overRisk = dailyM + s.durationMin > 180;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h2>90-Minuten-Fokus-Sprint</h2>
      <div class="muted">
        Ein Block = dokumentierte Belastung.
        Vorher kurze Buddha-Pause einplanen, wenn du angeschlagen bist.
      </div>
      <div class="ctl" style="margin-top:6px">
        <label>Ziel dieses Sprints</label>
        <textarea id="spNote" placeholder="z. B. 1 Test-Audit-Struktur sch√§rfen, keine echten Kunden.">${escapeHTML(s.note||"")}</textarea>
      </div>
      <div class="row wrap" style="margin-top:6px">
        <span class="badge" id="spTimer">${fmtTimer(remaining)}</span>
        <span class="pill"><span>Status</span><span class="tag">${s.running?"l√§uft":"bereit"}</span></span>
        <span class="pill" style="color:${overRisk?'#fb7185':'#22c55e'}">
          <span>Nach Sprint:</span>
          <span class="tag">${dailyM + s.durationMin}/180 Min</span>
        </span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary block" id="spStart">${s.running?"Fortsetzen":"Starten"}</button>
        <button class="btn warn block" id="spReset">Reset</button>
      </div>
    `;
    wrap.append(card);
    view.append(wrap);

    card.querySelector("#spNote").oninput = e=>{
      state.sprint.note = e.target.value;
      saveState();
    };
    card.querySelector("#spStart").onclick = ()=>{
      if(!state.sprint.running){
        const next = (state.daily.activeMinutes||0) + state.sprint.durationMin;
        if(next > 180){
          const ok = confirm("Dieser Sprint √ºberschreitet die 3h-Leitplanke. Nur starten, wenn du die Folgen im Gesundheitslog dokumentierst.");
          if(!ok) return;
        }
        startSprint();
      }
    };
    card.querySelector("#spReset").onclick = ()=>{
      stopSprint(true);
      saveState(); render();
    };
  }

  function startSprint(){
    if(state.sprint.running) return;
    state.sprint.running = true;
    if(!state.sprint.startedAt){
      state.sprint.startedAt = Date.now();
      state.sprint.remainingSec = state.sprint.durationMin * 60;
    }
    if(sprintTimer) clearInterval(sprintTimer);
    sprintTimer = setInterval(()=>{
      if(state.sprint.remainingSec > 0){
        state.sprint.remainingSec -= 1;
        const b = el("#spTimer");
        if(b) b.textContent = fmtTimer(state.sprint.remainingSec);
      }else{
        stopSprint(false);
        alert("Fokus-Sprint beendet. Ergebnis im Fakten-/Exec-Log sichern.");
        state.home.kpis.sprints = (state.home.kpis.sprints||0)+1;
        state.daily.activeMinutes = (state.daily.activeMinutes||0) + state.sprint.durationMin;
        saveState(); render();
      }
    },1000);
    saveState(); render();
  }

  function stopSprint(reset){
    state.sprint.running = false;
    if(sprintTimer){clearInterval(sprintTimer);sprintTimer=null;}
    if(reset){
      state.sprint.startedAt = null;
      state.sprint.remainingSec = state.sprint.durationMin * 60;
      state.sprint.note = "";
    }
  }

  function fmtTimer(sec){
    const s = Math.max(0,sec|0);
    const m = Math.floor(s/60).toString().padStart(2,"0");
    const r = (s%60).toString().padStart(2,"0");
    return `${m}:${r}`;
  }

  // ---------- PROTOTYPEN (√úBUNGS-AUDITS) ----------

  const GATE_ITEMS = [
    ["klartext","Klarer, verst√§ndlicher Befund"],
    ["belege","Mindestens 2 belastbare Belege"],
    ["struktur","Saubere Struktur / Dateinamen"],
    ["prio","P0/P1/P2 nachvollziehbar"],
    ["mobil","Mobile-First gepr√ºft"],
    ["intern","Nur intern, keine echte Beauftragung"],
    ["exec","Kurzfassung f√ºr Tag X m√∂glich"]
  ];

  function renderPrototypen(){
    const wrap = document.createElement("div");
    wrap.className = "grid";

    const mk = document.createElement("div");
    mk.className = "card";
    mk.innerHTML = `
      <h2>Prototyp (√úbungs-Audit) anlegen</h2>
      <div class="muted">
        Nur Test-/Wettbewerbsdomains oder eigene Projekte.
        Kein echter Kunde, keine Rechnung, kein Lockangebot.
      </div>
      <div class="row" style="margin-top:6px">
        <div class="ctl">
          <label>Domain/Label</label>
          <input id="aDom" type="text" placeholder="z. B. demo-immo.test">
        </div>
        <div class="ctl">
          <label>Status</label>
          <select id="aStage">
            <option>NEU</option>
            <option>IN_ARBEIT</option>
            <option>ENTWURF</option>
            <option>FERTIG_INTERNAL</option>
          </select>
        </div>
      </div>
      <button class="btn ok block" id="aAdd" style="margin-top:6px">Prototyp speichern</button>
    `;
    mk.querySelector("#aAdd").onclick = ()=>{
      const dom = mk.querySelector("#aDom").value.trim();
      const st  = mk.querySelector("#aStage").value;
      if(!dom) return;
      state.audits.unshift({
        id:id(),
        domain:dom,
        stage:st,
        created:todayISO(),
        gate:{},
        gateScore:0
      });
      saveState(); render();
    };
    wrap.append(mk);

    const filter = document.createElement("div");
    filter.className = "card";
    filter.innerHTML = `
      <h2>Prototypen-√úbersicht (${state.audits.length})</h2>
      <div class="row">
        <div class="ctl">
          <label>Suche</label>
          <input id="fText" type="text" placeholder="Domain / Label">
        </div>
        <div class="ctl">
          <label>Status</label>
          <select id="fStage">
            <option value="">(alle)</option>
            <option>NEU</option>
            <option>IN_ARBEIT</option>
            <option>ENTWURF</option>
            <option>FERTIG_INTERNAL</option>
          </select>
        </div>
      </div>
    `;
    wrap.append(filter);

    const listCard = document.createElement("div");
    listCard.className = "card";
    const ul = document.createElement("div");
    ul.className = "list";

    function applyFilter(){
      ul.innerHTML = "";
      const q  = (filter.querySelector("#fText").value||"").toLowerCase();
      const st = filter.querySelector("#fStage").value;
      state.audits
        .filter(a=>(!q || a.domain.toLowerCase().includes(q)) && (!st || a.stage===st))
        .forEach(a=>{
          const linked = state.evidence.filter(ev=>ev.auditId===a.id);
          const it = document.createElement("div");
          it.className = "item";
          it.innerHTML = `
            <div style="flex:1">
              <strong>${escapeHTML(a.domain)}</strong>
              <div class="muted">
                Status: ${a.stage} ¬∑ seit ${a.created}
                ${a.gateScore>=90?` ¬∑ <span class="okc">Gate ${a.gateScore}</span>`:""}
              </div>
              <details style="margin-top:4px">
                <summary>Gate-Check (Ziel ‚â• 90)</summary>
                ${renderGateChecklistHTML(a)}
              </details>
              <details style="margin-top:4px">
                <summary>Evidence (${linked.length})</summary>
                <div class="muted">
                  ${linked.length
                    ? linked.map(ev=>`- [${ev.type}] ${escapeHTML(ev.title||"(ohne Titel)")}`).join("<br>")
                    : "Noch keine Evidence verkn√ºpft."}
                </div>
              </details>
            </div>
            <div class="ctl" style="width:100px">
              <label>Stage</label>
              <select class="auditStage" data-id="${a.id}">
                ${["NEU","IN_ARBEIT","ENTWURF","FERTIG_INTERNAL"].map(s=>`<option ${a.stage===s?"selected":""}>${s}</option>`).join("")}
              </select>
            </div>
            <button class="btn ghost danger" data-del="${a.id}">‚úï</button>
          `;
          ul.append(it);
        });
    }

    filter.querySelectorAll("input,select").forEach(n=>n.oninput = applyFilter);
    applyFilter();

    ul.addEventListener("change",e=>{
      const sel = e.target.closest(".auditStage");
      if(sel){
        const a = state.audits.find(x=>x.id===sel.dataset.id);
        if(a){a.stage = sel.value; saveState();}
      }
      const gateChk = e.target.closest('input[type="checkbox"][data-gate]');
      if(gateChk){
        const aid = gateChk.dataset.aid;
        const key = gateChk.dataset.gate;
        const a = state.audits.find(x=>x.id===aid);
        if(a){
          a.gate = a.gate || {};
          a.gate[key] = !!gateChk.checked;
          a.gateScore = calcGateScore(a.gate);
          saveState(); render();
        }
      }
    });

    ul.addEventListener("click",e=>{
      const del = e.target.closest("button[data-del]");
      if(del){
        const idd = del.dataset.del;
        const i = state.audits.findIndex(x=>x.id===idd);
        if(i>-1){state.audits.splice(i,1); saveState(); render();}
      }
    });

    listCard.append(ul);
    wrap.append(listCard);
    view.append(wrap);
  }

  function renderGateChecklistHTML(a){
    const gate = a.gate || {};
    return `
      <div class="list" style="margin-top:4px">
        ${GATE_ITEMS.map(([k,label])=>`
          <label class="row">
            <input type="checkbox" data-gate="${k}" data-aid="${a.id}" ${gate[k]?"checked":""}>
            <span>${label}</span>
          </label>
        `).join("")}
        <div class="pill" style="margin-top:4px">
          <span>Score</span><span class="tag">${a.gateScore||0}</span>
        </div>
      </div>
    `;
  }

  function calcGateScore(gate){
    const total = GATE_ITEMS.length;
    const ok = GATE_ITEMS.reduce((n,[k])=>n+(gate[k]?1:0),0);
    return Math.round(100*ok/total);
  }

  // ---------- EVIDENCE ----------

  function renderEvidence(){
    const wrap = document.createElement("div");
    wrap.className = "grid";

    const form = document.createElement("div");
    form.className = "card";
    form.innerHTML = `
      <h2>Evidence (intern)</h2>
      <div class="muted">
        Nur Funde aus Prototypen. Nichts, was wie ein echter Kundenbericht wirkt.
      </div>
      <div class="ctl" style="margin-top:6px">
        <label>Titel</label>
        <input id="eTitle" type="text" placeholder="z. B. P0-CTA verdeckt (Testfall)">
      </div>
      <div class="ctl">
        <label>Ablage (optional)</label>
        <input id="eUrl" type="url" placeholder="Pfad oder Notiz zur Datei">
      </div>
      <div class="row" style="margin-top:4px">
        <div class="ctl">
          <label>Typ</label>
          <select id="eType">
            <option>P0</option><option>P1</option><option>P2</option>
            <option>TECH</option><option>UX</option><option>SEO</option><option>SONSTIG</option>
          </select>
        </div>
        <div class="ctl">
          <label>Prototyp zuordnen</label>
          <select id="eAudit">
            <option value="">(optional)</option>
            ${state.audits.map(a=>`<option value="${a.id}">${escapeHTML(a.domain)}</option>`).join("")}
          </select>
        </div>
      </div>
      <div class="ctl">
        <label>Notiz</label>
        <textarea id="eNote" placeholder="Kurz, pr√ºffreundlich, ohne Marketing."></textarea>
      </div>
      <button class="btn ok block" id="eAdd" style="margin-top:6px">Evidence speichern</button>
    `;
    form.querySelector("#eAdd").onclick = ()=>{
      const title = form.querySelector("#eTitle").value.trim();
      const url   = form.querySelector("#eUrl").value.trim();
      const type  = form.querySelector("#eType").value;
      const auditId = form.querySelector("#eAudit").value || null;
      const note  = form.querySelector("#eNote").value.trim();
      if(!title && !note) return;
      state.evidence.unshift({
        id:id(),
        title,
        url,
        type,
        auditId,
        note,
        ts:new Date().toISOString()
      });
      saveState(); render();
    };
    wrap.append(form);

    const list = document.createElement("div");
    list.className = "card";
    list.innerHTML = `<h2>Evidence-Liste (${state.evidence.length})</h2>`;
    const ul = document.createElement("div");
    ul.className = "list";
    state.evidence.slice(0,120).forEach(ev=>{
      const a = ev.auditId && state.audits.find(x=>x.id===ev.auditId);
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div style="flex:1">
          <strong>${escapeHTML(ev.title || "(ohne Titel)")}</strong>
          <div class="muted">
            ${new Date(ev.ts).toLocaleString("de-DE")}
            ¬∑ ${ev.type}
            ¬∑ ${a ? escapeHTML(a.domain) : "kein Prototyp verkn√ºpft"}
          </div>
          ${ev.url?`<div class="muted">Ablage: ${escapeHTML(ev.url)}</div>`:""}
          ${ev.note?`<div class="muted" style="margin-top:3px;font-family:var(--mono);font-size:10px">${escapeHTML(ev.note)}</div>`:""}
        </div>
        <button class="btn ghost danger" data-del="${ev.id}">‚úï</button>
      `;
      ul.append(it);
    });
    ul.addEventListener("click",e=>{
      const del = e.target.closest("button[data-del]");
      if(del){
        const idd = del.dataset.del;
        const i = state.evidence.findIndex(x=>x.id===idd);
        if(i>-1){state.evidence.splice(i,1);saveState();render();}
      }
    });
    list.append(ul);
    wrap.append(list);

    view.append(wrap);
  }

  // ---------- OUTREACH ----------

  function renderOutreach(){
    const wrap = document.createElement("div");
    wrap.className = "grid";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h2>Explorationskontakte (kalt, rechtssicher)</h2>
      <div class="muted">
        Erlaubt: wenige, klar deklarierte Vorgespr√§che. Kein Angebot, kein Preis, keine Zusage vor Freigabe.
      </div>
      <div class="row" style="margin-top:6px">
        <div class="ctl">
          <label>Kontakt</label>
          <input id="oName" type="text" placeholder="Firma / Person">
        </div>
        <div class="ctl">
          <label>Kanal</label>
          <select id="oChannel">
            <option>Email</option><option>LinkedIn</option><option>Telefon</option><option>Sonstiges</option>
          </select>
        </div>
      </div>
      <div class="ctl">
        <label>Adresse/Handle</label>
        <input id="oHandle" type="text" placeholder="mail@..., URL oder Profil">
      </div>
      <div class="ctl">
        <label>Notiz</label>
        <textarea id="oNote" placeholder="Kontext, Interesse, Hinweis auf Start erst nach Freigabe."></textarea>
      </div>
      <button class="btn ok block" id="oAdd" style="margin-top:6px">Speichern</button>
      <div class="template-box">
        <strong>Startklausel (Blueprint)</strong>
        <pre id="startClause">
Ich befinde mich in einer rechtlichen und gesundheitlichen Neuordnungsphase (u. a. laufendes Renten- und Insolvenzverfahren).
Bis zur schriftlichen Freigabe meiner selbstst√§ndigen T√§tigkeit durch das Insolvenzgericht/den Insolvenzverwalter
kann und werde ich keine Auftr√§ge verbindlich annehmen, keine Leistungen ausf√ºhren und keine Rechnungen stellen.
Gerne kann ich Ihr Feedback zu einer m√∂glichen Zusammenarbeit ab 2026 aufnehmen; alle Gespr√§che bis dahin dienen
ausschlie√ülich der unverbindlichen Vorbereitung.</pre>
        <button class="btn block copy-btn" data-copy-target="startClause">Startklausel kopieren</button>
      </div>
    `;
    card.querySelector("#oAdd").onclick = ()=>{
      const contact = card.querySelector("#oName").value.trim();
      const channel = card.querySelector("#oChannel").value;
      const handle  = card.querySelector("#oHandle").value.trim();
      const notes   = card.querySelector("#oNote").value.trim();
      if(!contact) return;
      state.outreach.unshift({
        id:id(),
        contact,
        channel,
        handle,
        notes,
        status:"EXPLORATION",
        created:todayISO()
      });
      state.daily.outreachToday = (state.daily.outreachToday||0)+1;
      saveState(); render();
    };
    wrap.append(card);

    const list = document.createElement("div");
    list.className = "card";
    list.innerHTML = `<h2>Kontakte (${state.outreach.length})</h2>`;
    const ul = document.createElement("div");
    ul.className = "list";
    state.outreach.forEach(o=>{
      const col = o.status==="EXPLORATION (Klausel OK)" ? "okc" : "warnc";
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div style="flex:1">
          <strong>${escapeHTML(o.contact)}</strong>
          <div class="muted">
            ${o.channel}${o.handle?" ¬∑ "+escapeHTML(o.handle):""}
            ¬∑ ${o.created}
            ¬∑ <span class="${col}">${o.status}</span>
          </div>
          ${o.notes?`<div class="muted" style="margin-top:3px">${escapeHTML(o.notes)}</div>`:""}
        </div>
        <div class="row">
          <button class="btn ghost ok" data-act="OK" data-id="${o.id}">Klausel OK</button>
          <button class="btn ghost danger" data-act="DEL" data-id="${o.id}">‚úï</button>
        </div>
      `;
      ul.append(it);
    });
    ul.addEventListener("click",e=>{
      const b = e.target.closest("button[data-act]");
      if(!b) return;
      const idd = b.dataset.id;
      const o = state.outreach.find(x=>x.id===idd);
      if(!o) return;
      if(b.dataset.act==="OK") o.status = "EXPLORATION (Klausel OK)";
      if(b.dataset.act==="DEL"){
        const i = state.outreach.findIndex(x=>x.id===idd);
        if(i>-1) state.outreach.splice(i,1);
      }
      saveState(); render();
    });
    list.append(ul);
    wrap.append(list);

    view.append(wrap);
  }

  // ---------- MANIFEST (80-TAGE-PLAN) ----------

  function renderManifest(){
    const d = document.createElement("div");
    d.className = "card roadmap-content";
    const {total,passed} = phoenixDayInfo();
    const p = state.phoenix;

    d.innerHTML = `
      <h2>PHOENIX 80-Tage-Manifest</h2>
      <p class="muted">
        Dieses Manifest verkn√ºpft deinen real laufenden Mini-Betrieb mit dem 80-Tage-Fenster:
        Ziel: pr√ºff√§hige Entschuldung, stabiles Leistungsbild, startklares Business-Modell.
      </p>

      <h3>Phase 1 ¬∑ Fundament (Tag 1‚Äì14)</h3>
      <ul>
        <li>Zeitjournal t√§glich f√ºhren (aktive Minuten + 3-Log-System).</li>
        <li>Kurz-E√úR R√ºckblick 2023‚Äìheute erstellen (Mini-Betrieb). </li>
        <li>DRV informieren & Unterlagen in Arbeit anzeigen.</li>
      </ul>

      <h3>Phase 2 ¬∑ Kalte Werkstatt & Mini-Betrieb (Tag 15‚Äì40)</h3>
      <ul>
        <li>2‚Äì5 Prototypen-Audits intern erstellen (Fokus Immobilien/SEO).</li>
        <li>Evidence-Datenbank f√ºllen (P0/P1/UX/Tech-Befunde).</li>
        <li>Mini-Betrieb klein, transparent, l√ºckenlos verbucht.</li>
      </ul>

      <h3>Phase 3 ¬∑ Schnitt & Routenentscheidung (Tag 41‚Äì65)</h3>
      <ul>
        <li>Route A: Vorbereitung des formellen Cuts der Selbstst√§ndigkeit,
            um Verbraucherinsolvenz zu erm√∂glichen.</li>
        <li>Route B: Vorbereitung einer Regelinsolvenz mit sauberem
            Freigabeantrag nach ¬ß 35 Abs. 2 InsO.</li>
        <li>Tag-X-Paket-Entwurf mit Prototypen & Evidence.</li>
      </ul>

      <h3>Phase 4 ¬∑ Versiegelung (Tag 66‚Äì80)</h3>
      <ul>
        <li>Vollst√§ndige Antragsunterlagen fertigstellen.</li>
        <li>Tag-X-Paket finalisieren (noch nicht versenden ohne Beratung).</li>
        <li>JSON-Backup exportieren und sicher ablegen.</li>
      </ul>

      <h3>Live-Status (autonom aus deinen Eingaben)</h3>
      <ul>
        <li>Zeitjournal-Tage: <strong>${new Set(state.logbook.map(l=>l.date)).size}</strong> / 80</li>
        <li>Fokus-Sprints: <strong>${state.home.kpis.sprints||0}</strong></li>
        <li>FERTIG_INTERNAL Prototypen: <strong>${state.audits.filter(a=>a.stage==="FERTIG_INTERNAL").length}</strong> (Ziel 3‚Äì5)</li>
        <li>Explorationskontakte mit Klausel OK:
          <strong>${state.outreach.filter(o=>o.status==="EXPLORATION (Klausel OK)").length}</strong></li>
      </ul>
      <p class="muted">
        Tag ${passed}/${total}: Dieses Dashboard ersetzt kein Gericht,
        aber es liefert deiner anwaltlichen Vertretung, DRV und dem Insolvenzverwalter
        eine saubere, konsistente Geschichte.
      </p>
    `;
    view.append(d);
  }

  // ---------- GENERATOR ----------

  function renderGenerator(){
    const d = document.createElement("div");
    d.className = "grid";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h2>‚ö° Beweismittel-Generator</h2>
      <p class="muted">
        Aus deinen Daten entstehen drei Texte:
        Tag-X-Paket f√ºr den Insolvenzverwalter,
        Leistungsbild f√ºr die DRV,
        Kurz-E√úR-Report f√ºr Steuer/Anwalt.
        Alles offline, du kopierst nur Inhalte in deine finalen PDFs.
      </p>

      <h3>1 ¬∑ Tag-X-Paket (IV / ¬ß 35 Abs. 2 InsO)</h3>
      <button class="btn primary block" id="gIV">Entwurf erzeugen</button>

      <h3 style="margin-top:10px;">2 ¬∑ DRV-Leistungsbild</h3>
      <div class="row">
        <div class="ctl">
          <label>Zeitraum</label>
          <select id="gDRVRange">
            <option value="30">Letzte 30 Tage</option>
            <option value="60">Letzte 60 Tage</option>
            <option value="all">Komplette PHOENIX-Phase</option>
          </select>
        </div>
        <button class="btn ok block" id="gDRV">Report erzeugen</button>
      </div>

      <h3 style="margin-top:10px;">3 ¬∑ Kurz-E√úR / Hinzuverdienst</h3>
      <button class="btn block" id="gEUE">Kurz-E√úR erzeugen</button>

      <div class="template-box" id="genOutBox" style="display:none;">
        <strong id="genTitle">Ergebnis</strong>
        <button class="btn block copy-btn" data-copy-target="genOut">Inhalt kopieren</button>
        <pre id="genOut"></pre>
      </div>
    `;
    d.append(card);
    view.append(d);

    const outBox = el("#genOutBox");
    const outTit = el("#genTitle");
    const out    = el("#genOut");

    el("#gIV").onclick = ()=>{
      archiveCurrentDaily();
      const audits = state.audits.filter(a=>a.stage==="FERTIG_INTERNAL");
      const outreach = state.outreach.filter(o=>o.status==="EXPLORATION (Klausel OK)");
      const execLogs = filterLogsByRange([...state.logbook,state.daily],'30')
        .filter(l=>(l.execLog||"").trim());
      const route = state.phoenix.targetRoute;

      let s = "";
      s += "ENTWURF ¬∑ TAG-X-PAKET / ANTRAG AUF FREIGABE SELBSTST√ÑNDIGER T√ÑTIGKEIT (¬ß 35 ABS. 2 INSO)\n";
      s += "-------------------------------------------------------------------------------\n\n";
      s += "1. Ausgangslage\n";
      s += "- Laufender Mini-Betrieb (freiberuflich, geringes Volumen, vollst√§ndig erkl√§rt).\n";
      s += "- Geplante Entschuldung im Rahmen " +
           (route==="A"
             ? "einer Verbraucherinsolvenz nach Einstellung der selbstst√§ndigen T√§tigkeit.\n"
             : "einer Regelinsolvenz mit beantragter Freigabe meiner selbstst√§ndigen T√§tigkeit.\n");
      s += "- Parallel: Aufbau eines klar umrissenen Angebots 'Mobile-First SEO Audits (Immobilien)'.\n\n";

      s += "2. Prototypen (interne Referenzen)\n";
      if(!audits.length){
        s += "- Noch keine FERTIG_INTERNAL-Prototypen dokumentiert.\n";
      }else{
        audits.forEach((a,i)=>{
          s += `- Prototyp ${i+1}: ${a.domain} (FERTIG_INTERNAL, Gate-Score ${a.gateScore||0})\n`;
          const evs = state.evidence.filter(ev=>ev.auditId===a.id);
          if(evs.length){
            s += `  Evidence-Auszug:\n`;
            evs.slice(0,5).forEach(ev=>{
              s += `  ¬∑ [${ev.type}] ${ev.title}: ${ev.note.slice(0,120)}\n`;
            });
          }
        });
      }
      s += "\n3. Markt-Pipeline (unverbindlich)\n";
      if(!outreach.length){
        s += "- Keine verbindlichen Voranfragen. Nur Konzeptniveau.\n";
      }else{
        outreach.forEach(o=>{
          s += `- ${o.contact} (${o.channel}): Explorationskontakt mit dokumentierter Startklausel.\n`;
        });
      }

      s += "\n4. Compliance-Profil\n";
      s += "- Keine Rechnungsstellung f√ºr Audits innerhalb des PHOENIX-Zeitraums ohne Freigabe.\n";
      s += "- Mini-Betrieb √ºber E√úR und Logbuch dokumentiert.\n";
      s += "- Executive-Logs (Auszug letzte 30 Tage) belegen Vorbereitung statt faktischer Vollaus√ºbung.\n\n";
      execLogs.forEach(l=>{
        s += `  ${l.date}: ${l.execLog}\n`;
      });

      s += "\n5. Vorschlag Abf√ºhrungsmodell (Platzhalter)\n";
      s += "- Nach Erreichen stabiler Eink√ºnfte aus freigegebener T√§tigkeit: feste monatliche Quote,\n";
      s += "  orientiert an vergleichbaren Teilzeitnettoeinkommen.\n";

      outTit.textContent = "Tag-X-Paket ¬∑ Rohentwurf f√ºr Rechtsberatung / Insolvenzverwalter";
      out.textContent = s;
      outBox.style.display = "block";
    };

    el("#gDRV").onclick = ()=>{
      archiveCurrentDaily();
      const range = el("#gDRVRange").value;
      const logsRaw = [...state.logbook];
      const idx = logsRaw.findIndex(l=>l.date===state.daily.date);
      if(idx>-1) logsRaw[idx] = JSON.parse(JSON.stringify(state.daily));
      else logsRaw.push(JSON.parse(JSON.stringify(state.daily)));

      const logs = filterLogsByRange(logsRaw, range);
      let s = "";
      s += "PROTOKOLL ¬∑ LEISTUNGSBILD (INTERNER ENTWURF F√úR DRV-KOMMUNIKATION)\n";
      s += "-----------------------------------------------------------------\n";
      s += `Zeitraum: ${range==="all"?"gesamtes PHOENIX-Fenster":`letzte ${range} Tage`}\n\n`;
      let total = 0;
      if(!logs.length){
        s += "(Keine Eintr√§ge im gew√§hlten Zeitraum.)\n";
      }else{
        logs.forEach(l=>{
          total += l.activeMinutes||0;
          s += `Datum: ${l.date}\n`;
          s += `Arbeits√§hnliche Zeit: ${(l.activeMinutes||0)} Min\n`;
          s += `Belastungsnotiz: ${l.healthLog||"(keine notiert)"}\n`;
          s += "--------------------------------------------------\n";
        });
      }
      const avg = logs.length ? Math.round(total/logs.length) : 0;
      s += `\nDurchschnittliche arbeits√§hnliche Zeit: ${avg} Min/Tag.\n`;
      s += "Hinweis: Entwurf. Konkrete Bewertung und Grenzen immer mit der DRV abstimmen.\n";

      outTit.textContent = "Leistungsbild-Protokoll ¬∑ Entwurf f√ºr DRV";
      out.textContent = s;
      outBox.style.display = "block";
    };

    el("#gEUE").onclick = ()=>{
      archiveCurrentDaily();
      const byYear = {};
      state.finances.entries.forEach(e=>{
        const y = e.year || (e.date||"").slice(0,4);
        if(!byYear[y]) byYear[y]={ein:0,aus:0};
        if(e.type==="EIN") byYear[y].ein += Number(e.amount)||0;
        if(e.type==="AUS") byYear[y].aus += Number(e.amount)||0;
      });
      let s = "";
      s += "KURZ-E√úR (INTERNER AUSZUG)\n";
      s += "--------------------------\n\n";
      const years = Object.keys(byYear).sort();
      if(!years.length){
        s += "(Noch keine Eintr√§ge vorhanden.)\n";
      }else{
        years.forEach(y=>{
          const ein = byYear[y].ein;
          const aus = byYear[y].aus;
          s += `Jahr ${y}:\n`;
          s += `  Einnahmen: ${ein.toFixed(2)} ‚Ç¨\n`;
          s += `  Ausgaben:  ${aus.toFixed(2)} ‚Ç¨\n`;
          s += `  Gewinn:    ${(ein-aus).toFixed(2)} ‚Ç¨\n\n`;
        });
      }
      s += "Hinweis: Werte dienen als Basis f√ºr die offizielle Anlage S/E√úR in ELSTER.\n";

      outTit.textContent = "Kurz-E√úR ¬∑ Grundlage f√ºr Steuer / Beratung";
      out.textContent = s;
      outBox.style.display = "block";
    };
  }

})();
</script>
</body>
</html>